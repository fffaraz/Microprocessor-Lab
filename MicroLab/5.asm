.INCLUDE  "M32DEF.INC"


.EQU 	LCD_PORT = PORTB
.EQU	EN = 2
.EQU	RS = 0
.EQU	RW = 1
.DEF	LCD_DATA = R17
.DEF	TEMP1 = R16
.DEF	CNT = R18

.DEF	N = R19
.DEF	P = R20
.DEF	Q = R21

.DEF	NUMBER = R22

.DEF	YEKAN = R23
.DEF	DAHGAN = R24
.DEF	SADGAN = R25

.DEF 	ZERO_ASCII = R26



.ORG	0
	RJMP MAIN


MAIN:
	LDI	TEMP1, LOW(RAMEND)
	OUT SPL, TEMP1
	LDI	TEMP1, HIGH(RAMEND)
	OUT SPH, TEMP1

	CALL LCD_INIT	
	

	//initializing port c
	LDI		TEMP1 , 0x00
	OUT		DDRC , TEMP1

LOOP_ALAKI:

	//Calculating bcd digits
	IN		NUMBER , PINC	
	MOV 	N , NUMBER

	LDI		P , 100
	CALL	DEVIDE
	MOV		SADGAN , Q

	LDI		P , 10
	CALL	DEVIDE
	MOV		DAHGAN , Q

	MOV 	YEKAN , N

	//Adding '0' asci code to digits
	LDI 	ZERO_ASCII , '0'
	ADD		SADGAN , ZERO_ASCII
	ADD		DAHGAN , ZERO_ASCII
	ADD		YEKAN , ZERO_ASCII

	//Clearing LCD
	LDI		LCD_DATA, 0B10000000
	CALL 	LCD_CMD
	CALL 	DELAY

	//Showing digits on LCD
	MOV		LCD_DATA, SADGAN
	CALL 	LCD_DISPLAY
	CALL 	DELAY

	MOV		LCD_DATA, DAHGAN
	CALL 	LCD_DISPLAY
	CALL 	DELAY

	MOV		LCD_DATA, YEKAN
	CALL 	LCD_DISPLAY
	CALL 	DELAY



	RJMP	LOOP_ALAKI



DEVIDE:
LDI		Q ,0

DEVIDE_LOOP :

CP		N ,P
BRLO	DEVIDE_END
SUB		N , P
INC		Q
RJMP	DEVIDE_LOOP

DEVIDE_END:
RET


// SEND A COMMAND TO LCD
//
LCD_CMD:

MOV		TEMP1, LCD_DATA
ANDI 	TEMP1, 0xF0
OUT		LCD_PORT, TEMP1	
SBI 	LCD_PORT, EN
CBI		LCD_PORT, RW
CBI		LCD_PORT, RS
NOP
NOP
NOP
NOP
CBI		LCD_PORT, EN


MOV 	TEMP1, LCD_DATA
ANDI 	TEMP1, 0x0F
SWAP	TEMP1
OUT		LCD_PORT, TEMP1	
SBI 	LCD_PORT, EN
CBI		LCD_PORT, RW
CBI		LCD_PORT, RS
NOP
NOP
NOP
NOP
CBI		LCD_PORT, EN

RET



// DISPLAY THE LCD
//
LCD_DISPLAY:

MOV		TEMP1, LCD_DATA
ANDI 	TEMP1, 0xF0
OUT		LCD_PORT, TEMP1	
SBI 	LCD_PORT, EN
SBI		LCD_PORT, RS
CBI		LCD_PORT, RW
NOP
NOP
NOP
NOP
CBI		LCD_PORT, EN
CBI		LCD_PORT, RS


MOV 	TEMP1, LCD_DATA
ANDI 	TEMP1, 0x0F
SWAP	TEMP1
OUT		LCD_PORT, TEMP1	
SBI 	LCD_PORT, EN
SBI		LCD_PORT, RS
CBI		LCD_PORT, RW
NOP
NOP
NOP
NOP
CBI		LCD_PORT, EN
CBI		LCD_PORT, RS

RET




// INITIALIZE THE LCD
//
LCD_INIT:

LDI 	TEMP1, 0XFF
OUT 	DDRB, TEMP1


// FOR LINE DATA BASS
LDI 	LCD_DATA, 0B00100000
CALL 	LCD_CMD
CALL	DELAY

// TOW LINE LCD AND 5*7 DOT
LDI 	LCD_DATA, 0B00101000
CALL 	LCD_CMD
CALL	DELAY

// TOW LINE LCD AND 5*7 DOT
LDI 	LCD_DATA, 0B00101000
CALL 	LCD_CMD
CALL	DELAY

// TOW LINE LCD AND 5*7 DOT
LDI 	LCD_DATA, 0B00101000
CALL 	LCD_CMD
CALL	DELAY

// CLEAR LCD
LDI		LCD_DATA, 0B00000001
CALL 	LCD_CMD
CALL 	DELAY

// TURN ON LCD, TURN OF CURSOR AND CURSOR BLINKING
LDI		LCD_DATA, 0B00001100
CALL 	LCD_CMD
CALL 	DELAY

// SOME CONFIGURATIONS
LDI		LCD_DATA, 0B00000110
CALL 	LCD_CMD
CALL 	DELAY


RET




DELAY:
LDI 	CNT, 0X05
LDI 	ZH, 0XFF																
LDI 	ZL, 0XFF

FOR1:
	SBIW	Z, 1
	BRNE	FOR1

	LDI 	ZH, 0XFF																
	LDI 	ZL, 0XFF
	DEC		CNT
	BRNE	FOR1

RET

		

RET
